<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ================================= -->
    <!-- VISTA FORM ORDINI ESTESA          -->
    <!-- ================================= -->

    <record id="view_order_form_raccolta" model="ir.ui.view">
        <field name="name">sale.order.form.raccolta</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">

            <!-- Aggiungi ribbon per ordini raccolta -->
            <xpath expr="//form" position="inside">
                <widget name="web_ribbon" title="Raccolta Ordini" bg_color="bg-info"
                        attrs="{'invisible': [('raccolta_session_id', '=', False)]}"/>
            </xpath>

            <!-- Aggiungi smart buttons -->
            <xpath expr="//div[@name='button_box']" position="inside">

                <!-- Button sessione raccolta -->
                <button type="object" name="action_view_raccolta_session"
                        class="oe_stat_button" icon="fa-cogs"
                        attrs="{'invisible': [('raccolta_session_id', '=', False)]}">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text">Sessione</span>
                        <span class="o_stat_text">Raccolta</span>
                    </div>
                </button>

                <!-- Button DDT collegati -->
                <button type="object" name="action_view_ddts"
                        class="oe_stat_button" icon="fa-file-text-o"
                        attrs="{'invisible': [('ddt_count', '=', 0)]}">
                    <field name="ddt_count" widget="statinfo" string="DDT"/>
                </button>

                <!-- Button ricevute -->
                <button type="object" name="action_view_receipts"
                        class="oe_stat_button" icon="fa-print"
                        attrs="{'invisible': [('raccolta_session_id', '=', False)]}">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text">Stampa</span>
                        <span class="o_stat_text">Ricevuta</span>
                    </div>
                </button>

            </xpath>

            <!-- Aggiungi tab raccolta ordini -->
            <xpath expr="//notebook" position="inside">
                <page string="Raccolta Ordini" name="raccolta_info"
                      attrs="{'invisible': [('raccolta_session_id', '=', False)]}">

                    <group>
                        <group string="Informazioni Sessione">
                            <field name="raccolta_session_id" readonly="1"/>
                            <field name="raccolta_agent_id" readonly="1"/>
                            <field name="raccolta_agent_code" readonly="1"/>
                            <field name="raccolta_local_id" readonly="1"/>
                        </group>

                        <group string="Stato Offline">
                            <field name="created_offline" readonly="1"/>
                            <field name="sync_status" readonly="1"/>
                            <field name="synced_at" readonly="1"/>
                            <field name="offline_data" widget="text" readonly="1"
                                   attrs="{'invisible': [('offline_data', '=', False)]}"/>
                        </group>
                    </group>

                    <group>
                        <group string="Note Raccolta">
                            <field name="general_notes" widget="text" placeholder="Note generali ordine..."/>
                            <field name="internal_notes" widget="text" placeholder="Note interne (non stampate)..."/>
                            <field name="delivery_instructions" widget="text" placeholder="Istruzioni consegna..."/>
                        </group>

                        <group string="Opzioni Stampa">
                            <field name="require_signature"/>
                            <field name="print_receipt"/>
                            <field name="receipt_format" attrs="{'invisible': [('print_receipt', '=', False)]}"/>
                        </group>
                    </group>

                    <!-- Picking e DDT collegati -->
                    <group string="Documenti Collegati" attrs="{'invisible': [('picking_ids', '=', [])]}">
                        <field name="picking_ids" nolabel="1">
                            <tree string="Picking Collegati" create="false" edit="false">
                                <field name="name"/>
                                <field name="state"/>
                                <field name="scheduled_date"/>
                                <field name="location_dest_id"/>
                                <button name="action_view_picking" type="object" icon="fa-external-link" title="Apri Picking"/>
                            </tree>
                        </field>
                    </group>

                </page>
            </xpath>

            <!-- Aggiungi campi nelle righe ordine -->
            <xpath expr="//field[@name='order_line']/tree//field[@name='name']" position="after">
                <field name="note" placeholder="Note prodotto..." optional="hide"/>
            </xpath>

            <!-- Modifica header per ordini raccolta -->
            <xpath expr="//header" position="inside">

                <!-- Bottoni specifici raccolta -->
                <button name="action_print_receipt_48mm" type="object" string="Stampa 48mm"
                        class="btn-primary"
                        attrs="{'invisible': ['|', ('raccolta_session_id', '=', False), ('state', 'not in', ['draft', 'sent', 'sale'])]}"/>

                <button name="action_print_receipt_80mm" type="object" string="Stampa 80mm"
                        class="btn-secondary"
                        attrs="{'invisible': ['|', ('raccolta_session_id', '=', False), ('state', 'not in', ['draft', 'sent', 'sale'])]}"/>

                <button name="action_generate_ddt" type="object" string="Genera DDT"
                        class="btn-info"
                        attrs="{'invisible': ['|', ('raccolta_session_id', '=', False), ('state', '!=', 'sale')]}"/>

                <button name="action_force_sync" type="object" string="Sincronizza"
                        class="btn-warning"
                        attrs="{'invisible': ['|', ('raccolta_session_id', '=', False), ('sync_status', '=', 'synced')]}"/>

            </xpath>

        </field>
    </record>

    <!-- ================================= -->
    <!-- VISTA TREE ORDINI ESTESA          -->
    <!-- ================================= -->

    <record id="view_order_tree_raccolta" model="ir.ui.view">
        <field name="name">sale.order.tree.raccolta</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_quotation_tree"/>
        <field name="arch" type="xml">

            <!-- Aggiungi colonne raccolta -->
            <xpath expr="//field[@name='name']" position="after">
                <field name="raccolta_agent_code" string="Agente" optional="show"/>
                <field name="sync_status" string="Sync" optional="show"/>
            </xpath>

            <!-- Aggiungi filtri colore -->
            <xpath expr="//tree" position="attributes">
                <attribute name="decoration-info">raccolta_session_id != False and sync_status == 'pending'</attribute>
                <attribute name="decoration-success">raccolta_session_id != False and sync_status == 'synced'</attribute>
                <attribute name="decoration-warning">raccolta_session_id != False and created_offline == True</attribute>
            </xpath>

        </field>
    </record>

    <!-- ================================= -->
    <!-- VISTA SEARCH ORDINI ESTESA        -->
    <!-- ================================= -->

    <record id="view_sale_order_filter_raccolta" model="ir.ui.view">
        <field name="name">sale.order.search.raccolta</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_sales_order_filter"/>
        <field name="arch" type="xml">

            <!-- Aggiungi filtri raccolta -->
            <xpath expr="//filter[@name='my_quotation']" position="after">

                <separator/>

                <filter string="Ordini Raccolta" name="raccolta_orders"
                        domain="[('raccolta_session_id', '!=', False)]"/>

                <filter string="Creati Offline" name="offline_orders"
                        domain="[('created_offline', '=', True)]"/>

                <filter string="Da Sincronizzare" name="pending_sync"
                        domain="[('sync_status', '=', 'pending')]"/>

                <filter string="Sincronizzati" name="synced_orders"
                        domain="[('sync_status', '=', 'synced')]"/>

                <separator/>

                <filter string="Miei Ordini Raccolta" name="my_raccolta_orders"
                        domain="[('raccolta_agent_id', '=', uid)]"/>

            </xpath>

            <!-- Aggiungi ricerca per agente -->
            <xpath expr="//field[@name='name']" position="after">
                <field name="raccolta_agent_code" string="Codice Agente"/>
                <field name="raccolta_local_id" string="ID Locale"/>
            </xpath>

            <!-- Aggiungi raggruppamenti -->
            <xpath expr="//group" position="inside">
                <filter string="Agente" name="group_agent"
                        context="{'group_by': 'raccolta_agent_id'}"/>
                <filter string="Sessione" name="group_session"
                        context="{'group_by': 'raccolta_session_id'}"/>
                <filter string="Stato Sync" name="group_sync"
                        context="{'group_by': 'sync_status'}"/>
            </xpath>

        </field>
    </record>

    <!-- ================================= -->
    <!-- VISTA KANBAN ORDINI RACCOLTA      -->
    <!-- ================================= -->

    <record id="view_sale_order_kanban_raccolta" model="ir.ui.view">
        <field name="name">sale.order.kanban.raccolta</field>
        <field name="model">sale.order</field>
        <field name="arch" type="xml">
            <kanban default_group_by="state" class="o_kanban_small_column">
                <field name="state"/>
                <field name="raccolta_session_id"/>
                <field name="raccolta_agent_code"/>
                <field name="sync_status"/>
                <field name="amount_total"/>
                <field name="currency_id"/>
                <field name="partner_id"/>
                <field name="date_order"/>
                <field name="created_offline"/>

                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_card oe_kanban_global_click">

                            <!-- Header con badge -->
                            <div class="o_kanban_card_header">
                                <div class="o_kanban_card_header_title">
                                    <div class="o_primary">
                                        <field name="name"/>
                                    </div>
                                    <div class="text-muted">
                                        <field name="partner_id"/>
                                    </div>
                                </div>

                                <!-- Badge stato -->
                                <div class="o_kanban_card_manage_pane dropdown">
                                    <t t-if="record.raccolta_session_id.raw_value">
                                        <span class="badge badge-info">Raccolta</span>
                                    </t>
                                    <t t-if="record.created_offline.raw_value">
                                        <span class="badge badge-warning">Offline</span>
                                    </t>
                                    <t t-if="record.sync_status.raw_value == 'pending'">
                                        <span class="badge badge-danger">Da Sync</span>
                                    </t>
                                    <t t-if="record.sync_status.raw_value == 'synced'">
                                        <span class="badge badge-success">Synced</span>
                                    </t>
                                </div>
                            </div>

                            <!-- Contenuto -->
                            <div class="o_kanban_card_content">
                                <div class="o_kanban_primary_left">
                                    <div class="text-primary">
                                        <field name="amount_total" widget="monetary"/>
                                    </div>
                                </div>

                                <div class="o_kanban_primary_right">
                                    <div class="text-muted">
                                        <field name="date_order" widget="date"/>
                                    </div>
                                    <t t-if="record.raccolta_agent_code.raw_value">
                                        <div class="text-muted">
                                            Agente: <field name="raccolta_agent_code"/>
                                        </div>
                                    </t>
                                </div>
                            </div>

                            <!-- Footer con azioni -->
                            <div class="o_kanban_card_manage_pane">
                                <div class="o_kanban_card_manage_section o_kanban_manage_reports">
                                    <div>
                                        <a type="object" name="action_print_receipt_48mm" title="Stampa 48mm">
                                            <i class="fa fa-print"/> 48mm
                                        </a>
                                    </div>
                                    <div>
                                        <a type="object" name="action_view_raccolta_session" title="Vai a Sessione"
                                           t-if="record.raccolta_session_id.raw_value">
                                            <i class="fa fa-cogs"/> Sessione
                                        </a>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- ================================= -->
    <!-- AZIONI MENU RACCOLTA ORDINI      -->
    <!-- ================================= -->

    <record id="action_orders_raccolta" model="ir.actions.act_window">
        <field name="name">Ordini Raccolta</field>
        <field name="res_model">sale.order</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="domain">[('raccolta_session_id', '!=', False)]</field>
        <field name="context">{
            'default_raccolta_session_id': active_id,
            'search_default_raccolta_orders': 1
        }</field>
        <field name="view_ids" eval="[(5, 0, 0),
            (0, 0, {'view_mode': 'kanban', 'view_id': ref('view_sale_order_kanban_raccolta')}),
            (0, 0, {'view_mode': 'tree', 'view_id': ref('view_order_tree_raccolta')}),
            (0, 0, {'view_mode': 'form', 'view_id': ref('view_order_form_raccolta')})
        ]"/>
    </record>

    <record id="action_orders_pending_sync" model="ir.actions.act_window">
        <field name="name">Ordini da Sincronizzare</field>
        <field name="res_model">sale.order</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('sync_status', '=', 'pending')]</field>
        <field name="context">{'search_default_pending_sync': 1}</field>
    </record>

</odoo>

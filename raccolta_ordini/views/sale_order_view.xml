<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- ================================= -->
        <!-- ESTENSIONE FORM ORDINE VENDITA    -->
        <!-- ================================= -->

        <record id="view_order_form_raccolta" model="ir.ui.view">
            <field name="name">sale.order.form.raccolta</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_order_form"/>
            <field name="arch" type="xml">

                <!-- Aggiungi smart buttons -->
                <xpath expr="//div[@name='button_box']" position="inside">
                    <button name="action_print_receipt" type="object"
                            class="oe_stat_button" icon="fa-print"
                            attrs="{'invisible': [('is_raccolta_order', '=', False)]}">
                        <div class="o_field_widget o_stat_info">
                            <span class="o_stat_text">Stampa Ricevuta</span>
                        </div>
                    </button>

                    <button name="action_sync_order" type="object"
                            class="oe_stat_button" icon="fa-refresh"
                            attrs="{'invisible': ['|', ('is_raccolta_order', '=', False), ('sync_status', '=', 'synced')]}">
                        <div class="o_field_widget o_stat_info">
                            <span class="o_stat_text">Sincronizza</span>
                        </div>
                    </button>
                </xpath>

                <!-- Modifica header con azioni raccolta -->
                <xpath expr="//header" position="inside">
                    <button name="action_print_receipt" type="object"
                            string="Stampa Ricevuta" class="btn-primary"
                            attrs="{'invisible': [('is_raccolta_order', '=', False)]}"/>

                    <button name="action_sync_order" type="object"
                            string="Forza Sincronizzazione" class="btn-warning"
                            attrs="{'invisible': ['|', ('is_raccolta_order', '=', False), ('sync_status', '=', 'synced')]}"
                            confirm="Forzare la sincronizzazione di questo ordine?"/>
                </xpath>

                <!-- Aggiungi campi raccolta dopo partner -->
                <xpath expr="//field[@name='partner_id']" position="after">
                    <field name="is_raccolta_order" invisible="1"/>
                    <field name="raccolta_session_id" readonly="1"
                           attrs="{'invisible': [('is_raccolta_order', '=', False)]}"/>
                    <field name="raccolta_agent_id" readonly="1"
                           attrs="{'invisible': [('is_raccolta_order', '=', False)]}"/>
                </xpath>

                <!-- Aggiungi tab raccolta -->
                <xpath expr="//notebook" position="inside">
                    <page string="Raccolta Ordini" name="raccolta"
                          attrs="{'invisible': [('is_raccolta_order', '=', False)]}">

                        <group>
                            <group string="Informazioni Raccolta">
                                <field name="raccolta_session_id" readonly="1"/>
                                <field name="raccolta_agent_id" readonly="1"/>
                                <field name="agent_sequence_number" readonly="1"/>
                            </group>

                            <group string="Stato Offline">
                                <field name="offline_created" readonly="1"/>
                                <field name="sync_status" readonly="1"/>
                                <field name="created_offline_at" readonly="1"/>
                                <field name="synced_at" readonly="1"/>
                            </group>
                        </group>

                        <!-- Errori sincronizzazione -->
                        <group string="Sincronizzazione"
                               attrs="{'invisible': [('sync_error', '=', False)]}">
                            <field name="sync_error" nolabel="1" readonly="1"
                                   widget="text"/>
                        </group>

                        <!-- Firma cliente -->
                        <group string="Firma Cliente"
                               attrs="{'invisible': [('customer_signature', '=', False)]}">
                            <field name="customer_signature" widget="image" readonly="1"/>
                            <field name="signature_date" readonly="1"/>
                        </group>

                        <!-- Dati offline -->
                        <group string="Dati Offline (JSON)"
                               attrs="{'invisible': [('offline_data', '=', False)]}">
                            <field name="offline_data" widget="text" readonly="1"/>
                        </group>

                        <!-- Azioni -->
                        <div class="oe_clear">
                            <group>
                                <button name="action_print_receipt" type="object"
                                        string="Ristampa Ricevuta" class="btn-secondary"/>

                                <button name="mark_as_offline_created" type="object"
                                        string="Marca come Creato Offline" class="btn-warning"
                                        attrs="{'invisible': [('offline_created', '=', True)]}"
                                        confirm="Marcare questo ordine come creato offline?"/>
                            </group>
                        </div>
                    </page>
                </xpath>

            </field>
        </record>

        <!-- ================================= -->
        <!-- ESTENSIONE TREE ORDINE VENDITA    -->
        <!-- ================================= -->

        <record id="view_order_tree_raccolta" model="ir.ui.view">
            <field name="name">sale.order.tree.raccolta</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_quotation_tree"/>
            <field name="arch" type="xml">

                <!-- Aggiungi colonne raccolta -->
                <xpath expr="//field[@name='user_id']" position="after">
                    <field name="is_raccolta_order" invisible="1"/>
                    <field name="raccolta_agent_id" string="Agente"
                           attrs="{'invisible': [('is_raccolta_order', '=', False)]}"/>
                    <field name="agent_sequence_number" string="N. Agente"
                           attrs="{'invisible': [('is_raccolta_order', '=', False)]}"/>
                    <field name="sync_status" string="Sync" widget="badge"
                           decoration-success="sync_status=='synced'"
                           decoration-warning="sync_status=='pending'"
                           decoration-danger="sync_status=='error'"
                           attrs="{'invisible': [('is_raccolta_order', '=', False)]}"/>
                </xpath>

                <!-- Decorazioni per ordini raccolta -->
                <xpath expr="//tree" position="attributes">
                    <attribute name="decoration-info">is_raccolta_order==True</attribute>
                </xpath>

            </field>
        </record>

        <!-- ================================= -->
        <!-- ESTENSIONE SEARCH ORDINI          -->
        <!-- ================================= -->

        <record id="view_sales_order_filter_raccolta" model="ir.ui.view">
            <field name="name">sale.order.search.raccolta</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_sales_order_filter"/>
            <field name="arch" type="xml">

                <!-- Aggiungi filtri raccolta -->
                <xpath expr="//filter[@name='my_sale_orders_filter']" position="after">
                    <separator/>
                    <filter string="Ordini Raccolta" name="raccolta_orders"
                            domain="[('is_raccolta_order','=',True)]"
                            help="Solo ordini da raccolta"/>

                    <filter string="Da Sincronizzare" name="pending_sync"
                            domain="[('sync_status','in',['pending','error'])]"
                            help="Ordini in attesa di sincronizzazione"/>

                    <filter string="Creati Offline" name="offline_created"
                            domain="[('offline_created','=',True)]"
                            help="Ordini creati in modalitÃ  offline"/>
                </xpath>

                <!-- Aggiungi raggruppamenti -->
                <xpath expr="//group[@string='Group By']" position="inside">
                    <filter string="Agente Raccolta" name="group_by_agent"
                            context="{'group_by':'raccolta_agent_id'}"
                            domain="[('is_raccolta_order','=',True)]"/>
                    <filter string="Stato Sync" name="group_by_sync_status"
                            context="{'group_by':'sync_status'}"
                            domain="[('is_raccolta_order','=',True)]"/>
                </xpath>

            </field>
        </record>

        <!-- ================================= -->
        <!-- AZIONE ORDINI RACCOLTA            -->
        <!-- ================================= -->

        <record id="action_raccolta_orders" model="ir.actions.act_window">
            <field name="name">Ordini Raccolta</field>
            <field name="res_model">sale.order</field>
            <field name="view_mode">tree,kanban,form,calendar,pivot,graph,activity</field>
            <field name="domain">[('is_raccolta_order', '=', True)]</field>
            <field name="context">{
                'search_default_raccolta_orders': 1
            }</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Nessun ordine di raccolta trovato!
                </p>
                <p>
                    Gli ordini di raccolta vengono creati automaticamente quando gli agenti
                    utilizzano l'applicazione mobile per raccogliere ordini sul territorio.
                </p>
            </field>
        </record>

        <!-- ================================= -->
        <!-- VISTA KANBAN PERSONALIZZATA       -->
        <!-- ================================= -->

        <record id="view_raccolta_order_kanban" model="ir.ui.view">
            <field name="name">sale.order.kanban.raccolta</field>
            <field name="model">sale.order</field>
            <field name="arch" type="xml">
                <kanban class="o_kanban_mobile" default_group_by="state">
                    <field name="name"/>
                    <field name="partner_id"/>
                    <field name="raccolta_agent_id"/>
                    <field name="agent_sequence_number"/>
                    <field name="amount_total"/>
                    <field name="sync_status"/>
                    <field name="state"/>
                    <field name="date_order"/>

                    <templates>
                        <t t-name="kanban-box">
                            <div class="oe_kanban_card oe_kanban_global_click">
                                <div class="oe_kanban_content">
                                    <!-- Header -->
                                    <div class="oe_kanban_card_header">
                                        <div class="oe_kanban_card_header_title">
                                            <div class="o_kanban_record_title">
                                                <field name="name"/>
                                                <span class="badge badge-pill badge-info ml-1"
                                                      t-if="record.agent_sequence_number.raw_value">
                                                    <field name="agent_sequence_number"/>
                                                </span>
                                            </div>
                                            <div class="o_kanban_record_subtitle">
                                                <field name="partner_id"/>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Body -->
                                    <div class="oe_kanban_card_content">
                                        <div class="o_kanban_record_bottom">
                                            <div class="oe_kanban_bottom_left">
                                                <span class="badge badge-pill badge-primary">
                                                    <field name="amount_total" widget="monetary"/>
                                                </span>

                                                <span class="badge badge-pill"
                                                      t-att-class="{
                                                          'badge-success': record.sync_status.raw_value == 'synced',
                                                          'badge-warning': record.sync_status.raw_value == 'pending',
                                                          'badge-danger': record.sync_status.raw_value == 'error'
                                                      }">
                                                    <field name="sync_status"/>
                                                </span>
                                            </div>

                                            <div class="oe_kanban_bottom_right">
                                                <field name="raccolta_agent_id"/>
                                                <br/>
                                                <field name="date_order" widget="date"/>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

    </data>
</odoo>
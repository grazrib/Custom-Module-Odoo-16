<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- ================================= -->
        <!-- VISTA FORM UTENTI ESTESA          -->
        <!-- ================================= -->

        <record id="view_users_form_raccolta" model="ir.ui.view">
            <field name="name">res.users.form.raccolta</field>
            <field name="model">res.users</field>
            <field name="inherit_id" ref="base.view_users_form"/>
            <field name="arch" type="xml">

                <!-- Aggiungi tab Raccolta Ordini -->
                <xpath expr="//notebook" position="inside">
                    <page string="Raccolta Ordini" name="raccolta_ordini">
                        
                        <!-- Configurazione Base Agente -->
                        <group string="Configurazione Agente">
                            <field name="is_raccolta_agent"/>
                            <field name="agent_code" 
                                   attrs="{'invisible': [('is_raccolta_agent', '=', False)],
                                           'required': [('is_raccolta_agent', '=', True)]}"/>
                        </group>

                        <!-- Configurazione Offline -->
                        <group string="Configurazione Offline" 
                               attrs="{'invisible': [('is_raccolta_agent', '=', False)]}">
                            <field name="max_offline_orders"/>
                            <field name="offline_data_expiry_days"/>
                            <field name="auto_sync_enabled"/>
                        </group>

                        <!-- Sequenze Personalizzate -->
                        <group string="Sequenze Personalizzate" 
                               attrs="{'invisible': [('is_raccolta_agent', '=', False)]}">
                            <field name="order_sequence_id" readonly="1"/>
                            <field name="ddt_sequence_id" readonly="1"/>
                            <field name="picking_sequence_id" readonly="1"/>
                        </group>

                        <!-- Statistiche -->
                        <group string="Statistiche" 
                               attrs="{'invisible': [('is_raccolta_agent', '=', False)]}">
                            <field name="total_offline_orders" readonly="1"/>
                            <field name="pending_sync_count" readonly="1"/>
                            <field name="last_sync_date" readonly="1"/>
                        </group>

                        <!-- Azioni Agente -->
                        <div class="mt16" attrs="{'invisible': [('is_raccolta_agent', '=', False)]}">
                            <button name="action_setup_sequences" type="object"
                                    string="Configura Sequenze" class="btn-primary"
                                    attrs="{'invisible': [('order_sequence_id', '!=', False)]}"/>
                        </div>

                    </page>
                </xpath>

            </field>
        </record>

        <!-- ================================= -->
        <!-- VISTA TREE UTENTI ESTESA          -->
        <!-- ================================= -->

        <record id="view_users_tree_raccolta" model="ir.ui.view">
            <field name="name">res.users.tree.raccolta</field>
            <field name="model">res.users</field>
            <field name="inherit_id" ref="base.view_users_tree"/>
            <field name="arch" type="xml">

                <!-- Aggiungi colonne raccolta ordini -->
                <xpath expr="//field[@name='login_date']" position="after">
                    <field name="is_raccolta_agent"/>
                    <field name="agent_code"/>
                    <field name="total_offline_orders" sum="Totale Ordini"/>
                    <field name="pending_sync_count" sum="Totale da Sincronizzare"/>
                </xpath>

            </field>
        </record>

        <!-- ================================= -->
        <!-- VISTA SEARCH DEDICATA AGENTI      -->
        <!-- ================================= -->

        <record id="view_raccolta_agents_search" model="ir.ui.view">
            <field name="name">res.users.search.raccolta.agents</field>
            <field name="model">res.users</field>
            <field name="arch" type="xml">
                <search string="Cerca Agenti Raccolta">
                    
                    <!-- Campi ricerca -->
                    <field name="name" string="Nome"
                           filter_domain="[('name','ilike',self)]"/>
                    <field name="login" string="Login"/>
                    <field name="agent_code" string="Codice Agente"/>
                    
                    <separator/>
                    
                    <!-- Filtri solo su campi stored/ricercabili -->
                    <filter string="Agenti Attivi" name="active_agents"
                            domain="[('is_raccolta_agent','=',True),('active','=',True)]"/>
                    
                    <filter string="Con Sequenze" name="with_sequences"
                            domain="[('order_sequence_id','!=',False)]"/>

                    <filter string="Auto-Sync Abilitato" name="auto_sync_enabled"
                            domain="[('auto_sync_enabled','=',True)]"/>

                    <separator/>

                    <!-- Raggruppamenti -->
                    <group expand="0" string="Raggruppa per">
                        <filter string="Stato Agente" name="group_by_agent_status"
                                context="{'group_by':'is_raccolta_agent'}"/>
                        <filter string="Azienda" name="group_by_company"
                                context="{'group_by':'company_id'}"/>
                    </group>

                </search>
            </field>
        </record>

        <!-- ================================= -->
        <!-- ACTION AGENTI RACCOLTA            -->
        <!-- ================================= -->

        <record id="action_raccolta_agents" model="ir.actions.act_window">
            <field name="name">Agenti Raccolta Ordini</field>
            <field name="res_model">res.users</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">[('is_raccolta_agent', '=', True)]</field>
            <field name="search_view_id" ref="view_raccolta_agents_search"/>
            <field name="context">{'search_default_active_agents': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Configura il primo agente per la raccolta ordini
                </p>
                <p>
                    Gli agenti raccolta ordini possono utilizzare l'app mobile
                    per creare ordini offline con numerazione personalizzata.
                </p>
            </field>
        </record>

    </data>
</odoo>